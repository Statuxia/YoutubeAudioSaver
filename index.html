<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Загрузить музыку с YouTube</title>
    <link rel="stylesheet" type="text/css" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
    <h1 align="center">Загрузить музыку с YouTube</h1>
    <form id="downloadForm" action="/download" method="post">
        <label for="url">URL видео YouTube:</label><br>
        <input type="text" id="url" name="url"><br>
        <span id="speedValue">Скорость музыки: 1.0</span><br><br>
        <input type="range" min="0.5" max="2" step="0.1" value="1" id="speed" name="audioSpeed" oninput="changeSpeed()">
        <button type="submit" id="downloadButton">Скачать</button>
    </form>
    <br>
    <div class="messageBox" id="messageBox"></div>
    <br>
    <div class="social">
        <a href="https://github.com/Statuxia" target="_blank">
            <button class="githubButton" style="font-size:24px">GitHub <i class="fa fa-github"></i></button>
        </a>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            changeSpeed();
        });

        function changeSpeed() {
            var speedValue = document.getElementById('speed').value;
            document.getElementById('speedValue').textContent = "Скорость музыки: " + speedValue;
        }

        var response;
        var lock = false;
        document.getElementById('downloadForm').addEventListener('submit', function (event) {
            event.preventDefault();
            if (lock === true) {
                return;
            }
            var formData = new FormData(this);
            showMessage('Загрузка началась', true);
            fetch('/download', {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    url: formData.get("url"),
                    audioSpeed: formData.get("audioSpeed")
                })
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Произошла ошибка при загрузке файла');
                }
                this.response = response;
                return response.blob();
            }).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = getFileName(this.response.headers.get("Content-Disposition"));
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                showMessage('Файл успешно загружен', false);
            }).catch(error => {
                showMessage("Произошла ошибка при загрузке файла", false);
                console.error('Произошла ошибка:', error);
            });
        });

        function getFileName(contentDisposition) {
            if (contentDisposition) {
                var matches = /filename="([^"]*)"/.exec(contentDisposition);
                if (matches != null && matches.length > 1) {
                    return matches[1];
                }
            }
            return 'audio.mp3';
        }

        function showMessage(message, isLocked) {
            (lock = isLocked) === true ? lockButton() : unlockButton();
            var messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
        }

        function lockButton() {
            let button = document.getElementById("downloadButton");
            button.disable = false;
            button.style.backgroundColor = "gray";
            schedule(0);
        };

        function schedule(loopNumber) {
            if (lock === false) {
                return;
            }
            var messageBox = document.getElementById('messageBox');
            if (loopNumber < 3) {
                messageBox.textContent += ".";
                setTimeout(schedule, 400, ++loopNumber);
            } else {
                messageBox.textContent = "Загрузка началась";
                setTimeout(schedule, 400, 0);
            }
        }

        function unlockButton() {
            let button = document.getElementById("downloadButton");
            button.disable = true;
            button.style.backgroundColor = "#3d8b41";
        };
    </script>
</body>

</html>